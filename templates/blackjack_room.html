<!DOCTYPE html>
<html>

<head lang="en">
    <script src="http://ajax.googleapis.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>
    <script src="http://malsup.github.com/jquery.form.js"></script>
    <script src="/static/blackjack.js"></script>
    <link rel="stylesheet" type="text/css" href="/static/css/blackjack.css">
    <link rel="stylesheet" type="text/css" href="/static/css/card_sprites.css">
    <meta charset="UTF-8">
    <title></title>
    <style>
        body {
            background-image: url("/static/pokerfelt.jpg");
        }
    </style>
</head>

<body>

<div id="gameActions">
    <button id="startGame">Start Game</button>
    <span id="start"></span>
</div>

<div id="seatSelection">
    <div class="seatDiv" seatNumber=1 player=""></div>

    <div class="seatDiv" seatNumber=2 player=""></div>

    <div class="seatDiv" seatNumber=3 player=""></div>

    <div class="seatDiv" seatNumber=4 player=""></div>

    <div class="seatDiv" seatNumber=5 player=""></div>

</div>

</body>

<script>


    window.updatePage = function () {
        $.getScript("/static/blackjack.js", function () {
        var game = new Game(window.currentData);
        console.log('wut', game.active);
        game.addSeats();
        game.addPlayers();
        if (game.active) {
            for (var i = 0; i < game.seats.length; i++) {
                var seatString = 'div[seatNumber=' + i + 1 + ']';
                var seat = document.querySelector(seatString);
                console.log('doin it');
                seat.setAttribute('player', game.seats[i]['playerID']);
                if (seat['playerID'] != null) {
                    var player = game.getPlayer(seat['playerID']);
                    for (var h = 0; h < player.hands.length; h++) {
                        seat.appendChild(player.drawHand());
                    }
                } else {
                    var sitSpan = document.createElement('span');
                    sitSpan.innerHTML = 'Sit in this seat';
                    sitSpan.addEventListener('click', sitListener);
                    seat.appendChild(sitSpan);
                }
            }
        }
            })
    };

{#    $.getScript("/static/blackjack.js", function () {#}
{#        window.updatePage();#}
{#    });#}

    var request = new XMLHttpRequest();
    var onRequestChange = function () {
        if ((request.readyState == 4) && (request.status == 200)) {
            var data = JSON.parse(request.responseText);
            var a = JSON.stringify(data);
            var b = JSON.stringify(window.currentData);
            $('#start').html = 'Game started ' + data['time_delta'] + ' ago';
            if (a != b) {
                window.currentData = data;
                window.updatePage();
            } else {
                console.log(a == b);
                window.updatePage();
            }
        }
    };

    var getData = function () {
        request.onreadystatechange = onRequestChange;
        request.open('GET', '/game_stats/{{ game.id }}', true);
        request.send();
    };

    var dataTimer = setInterval(function () {
        getData();
    }, 1000);

</script>

</html>